generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(uuid())
  walletAddress String     @unique
  email         String?    @unique
  name          String?
  role          UserRole   @default(USER)
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  password      String?
  activities    Activity[]
  kyc           KYC?
  plans         Plan[]

  @@index([walletAddress])
  @@index([email])
}

model KYC {
  id              String    @id @default(uuid())
  userId          String    @unique
  fullName        String
  email           String
  dateOfBirth     DateTime?
  nationality     String?
  idType          IDType
  idNumber        String
  idDocumentUrl   String?
  idExpiryDate    DateTime?
  address         String?
  city            String?
  country         String?
  postalCode      String?
  status          KYCStatus @default(PENDING)
  submittedAt     DateTime  @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  kycDataHash     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([email])
}

model Plan {
  id                    String             @id @default(uuid())
  userId                String
  globalPlanId          Int?               @unique
  userPlanId            Int?
  txHash                String?
  planName              String
  planDescription       String
  assetType             AssetType
  assetAmount           String
  assetAmountWei        String
  distributionMethod    DistributionMethod
  transferDate          DateTime
  periodicPercentage    Int?
  status                PlanStatus         @default(PENDING)
  isClaimedFully        Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  earlyClaimEnabled     Boolean            @default(false)
  lastVerificationAt    DateTime?
  lastVerificationSent  DateTime?
  notifyBeneficiaries   Boolean            @default(false)
  proofOfLifeEnabled    Boolean            @default(false)
  verificationFailCount Int                @default(0)
  verificationToken     String?            @unique
  activities            Activity[]
  beneficiaries         Beneficiary[]
  distributions         Distribution[]
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([globalPlanId])
  @@index([status])
  @@index([transferDate])
  @@index([proofOfLifeEnabled])
}

model Beneficiary {
  id                  String          @id @default(uuid())
  planId              String
  beneficiaryIndex    Int
  name                String
  email               String
  relationship        String
  nameHash            String
  emailHash           String
  relationshipHash    String
  combinedHash        String
  allocatedPercentage Int
  allocatedAmount     String
  hasClaimed          Boolean         @default(false)
  claimedAt           DateTime?
  claimedByAddress    String?
  claimedAmount       String?
  claimTxHash         String?
  notificationSent    Boolean         @default(false)
  notificationSentAt  DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  claimCodeEncrypted  String
  claimCodeHash       String
  plan                Plan            @relation(fields: [planId], references: [id], onDelete: Cascade)
  beneficiaryKYC      BeneficiaryKYC?

  @@unique([planId, beneficiaryIndex])
  @@index([planId])
  @@index([email])
  @@index([hasClaimed])
}

model BeneficiaryKYC {
  id              String       @id @default(uuid())
  email           String
  fullName        String
  dateOfBirth     DateTime?
  nationality     String?
  idType          IDType
  idNumber        String
  idDocumentUrl   String?
  idExpiryDate    DateTime?
  address         String?
  city            String?
  country         String?
  postalCode      String?
  status          KYCStatus    @default(PENDING)
  submittedAt     DateTime     @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  beneficiaryId   String?      @unique
  kycDataHash     String?
  beneficiary     Beneficiary? @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)

  @@index([beneficiaryId])
  @@index([status])
  @@index([email])
}

model Distribution {
  id                 String             @id @default(uuid())
  planId             String
  periodNumber       Int
  amount             String
  scheduledDate      DateTime
  status             DistributionStatus @default(PENDING)
  executedAt         DateTime?
  txHash             String?
  notificationSent   Boolean            @default(false)
  notificationSentAt DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  plan               Plan               @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, periodNumber])
  @@index([planId])
  @@index([scheduledDate])
  @@index([status])
}

model Activity {
  id          String       @id @default(uuid())
  userId      String?
  planId      String?
  type        ActivityType
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())
  plan        Plan?        @relation(fields: [planId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([planId])
  @@index([type])
  @@index([createdAt])
}

model EmailQueue {
  id          String      @id @default(uuid())
  to          String
  subject     String
  body        String
  htmlBody    String?
  status      EmailStatus @default(PENDING)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3)
  lastError   String?
  scheduledAt DateTime    @default(now())
  sentAt      DateTime?
  metadata    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([status])
  @@index([scheduledAt])
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum IDType {
  PASSPORT
  DRIVERS_LICENSE
  NATIONAL_ID
  OTHER
}

enum AssetType {
  ERC20_TOKEN1
  ERC20_TOKEN2
  ERC20_TOKEN3
  NFT
}

enum DistributionMethod {
  LUMP_SUM
  QUARTERLY
  YEARLY
  MONTHLY
}

enum PlanStatus {
  ACTIVE
  EXECUTED
  CANCELLED
  PAUSED
  EXPIRED
  PENDING
}

enum DistributionStatus {
  PENDING
  NOTIFIED
  EXECUTED
  CANCELLED
}

enum ActivityType {
  USER_REGISTERED
  USER_LOGIN
  USER_LOGOUT
  KYC_SUBMITTED
  KYC_APPROVED
  KYC_REJECTED
  PLAN_CREATED
  PLAN_UPDATED
  PLAN_PAUSED
  PLAN_RESUMED
  PLAN_CANCELLED
  CLAIM_INITIATED
  CLAIM_VERIFIED
  CLAIM_COMPLETED
  CLAIM_FAILED
  DISTRIBUTION_SCHEDULED
  DISTRIBUTION_NOTIFIED
  DISTRIBUTION_EXECUTED
  ADMIN_ACTION
  SYSTEM_EVENT
  DISTRIBUTION_CANCELLED
  BENEFICIARY_KYC_SUBMITTED
  BENEFICIARY_KYC_APPROVED
  BENEFICIARY_KYC_REJECTED
}

enum EmailStatus {
  PENDING
  SENDING
  SENT
  FAILED
}
