// Prisma Schema for InheritX Backend
// Digital Inheritance Platform Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  email         String?  @unique
  password      String? // Hashed password for admin login
  name          String?
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  kyc        KYC?
  plans      Plan[]
  activities Activity[]

  @@index([walletAddress])
  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============================================
// KYC (Know Your Customer)
// ============================================

model KYC {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information (stored for verification)
  fullName    String
  email       String
  dateOfBirth DateTime?
  nationality String?

  // ID Document
  idType        IDType
  idNumber      String
  idDocumentUrl String? // Path to uploaded document
  idExpiryDate  DateTime?

  // Address (optional)
  address    String?
  city       String?
  country    String?
  postalCode String?

  // Verification
  status          KYCStatus @default(PENDING)
  submittedAt     DateTime  @default(now())
  reviewedAt      DateTime?
  reviewedBy      String? // Admin who reviewed
  rejectionReason String?

  // Hash stored on-chain for verification
  kycDataHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([email])
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum IDType {
  PASSPORT
  DRIVERS_LICENSE
  NATIONAL_ID
  OTHER
}

// ============================================
// INHERITANCE PLANS
// ============================================

model Plan {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // On-chain identifiers
  globalPlanId Int?    @unique // From smart contract
  userPlanId   Int? // User's local plan ID
  txHash       String? // Transaction hash

  // Plan Details (stored unhashed)
  planName        String
  planDescription String

  // Asset Information
  assetType      AssetType
  assetAmount    String // Stored as string for precision
  assetAmountWei String // Wei amount

  // Distribution
  distributionMethod DistributionMethod
  transferDate       DateTime
  periodicPercentage Int? // For non-lump sum

  // Claim Code (encrypted with JWT secret)
  claimCodeEncrypted String // Encrypted claim code
  claimCodeHash      String // Keccak256 hash (same as on-chain)

  // Status
  status         PlanStatus @default(PENDING)
  isClaimedFully Boolean    @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  beneficiaries Beneficiary[]
  distributions Distribution[]
  activities    Activity[]

  @@index([userId])
  @@index([globalPlanId])
  @@index([status])
  @@index([transferDate])
}

enum AssetType {
  ERC20_TOKEN1
  ERC20_TOKEN2
  ERC20_TOKEN3
  NFT
}

enum DistributionMethod {
  LUMP_SUM
  QUARTERLY
  YEARLY
  MONTHLY
}

enum PlanStatus {
  PENDING
  ACTIVE
  EXECUTED
  CANCELLED
  PAUSED
  EXPIRED
}

// ============================================
// BENEFICIARIES
// ============================================

model Beneficiary {
  id     String @id @default(uuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Beneficiary Index (matches on-chain)
  beneficiaryIndex Int

  // Personal Info (stored unhashed)
  name         String
  email        String
  relationship String

  // Hashes (same as on-chain)
  nameHash         String
  emailHash        String
  relationshipHash String
  combinedHash     String

  // Allocation
  allocatedPercentage Int // In basis points (10000 = 100%)
  allocatedAmount     String // Calculated amount

  // Claim Status
  hasClaimed       Boolean   @default(false)
  claimedAt        DateTime?
  claimedByAddress String?
  claimedAmount    String?
  claimTxHash      String?

  // Notification Status
  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, beneficiaryIndex])
  @@index([planId])
  @@index([email])
  @@index([hasClaimed])
}

// ============================================
// DISTRIBUTIONS (for periodic distributions)
// ============================================

model Distribution {
  id     String @id @default(uuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Period Info
  periodNumber  Int
  amount        String
  scheduledDate DateTime

  // Status
  status     DistributionStatus @default(PENDING)
  executedAt DateTime?
  txHash     String?

  // Notification
  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, periodNumber])
  @@index([planId])
  @@index([scheduledDate])
  @@index([status])
}

enum DistributionStatus {
  PENDING
  NOTIFIED
  EXECUTED
  CANCELLED
}

// ============================================
// ACTIVITY LOG
// ============================================

model Activity {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id], onDelete: SetNull)

  type        ActivityType
  description String
  metadata    Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([planId])
  @@index([type])
  @@index([createdAt])
}

enum ActivityType {
  // User Activities
  USER_REGISTERED
  USER_LOGIN
  USER_LOGOUT

  // KYC Activities
  KYC_SUBMITTED
  KYC_APPROVED
  KYC_REJECTED

  // Plan Activities
  PLAN_CREATED
  PLAN_UPDATED
  PLAN_PAUSED
  PLAN_RESUMED
  PLAN_CANCELLED

  // Claim Activities
  CLAIM_INITIATED
  CLAIM_VERIFIED
  CLAIM_COMPLETED
  CLAIM_FAILED

  // Distribution Activities
  DISTRIBUTION_SCHEDULED
  DISTRIBUTION_NOTIFIED
  DISTRIBUTION_EXECUTED

  // Admin Activities
  ADMIN_ACTION
  SYSTEM_EVENT
}

// ============================================
// EMAIL QUEUE (for notifications)
// ============================================

model EmailQueue {
  id       String  @id @default(uuid())
  to       String
  subject  String
  body     String  @db.Text
  htmlBody String? @db.Text

  status      EmailStatus @default(PENDING)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3)
  lastError   String?

  scheduledAt DateTime  @default(now())
  sentAt      DateTime?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
}

enum EmailStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

// ============================================
// ADMIN SETTINGS
// ============================================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  type      String   @default("string")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}
